## 트랜잭션과 격리성

데이터베이스 트랜잭션(Database Transaction)은 데이터베이스 관리 시스템 또는 유사한 시스템에서 상호작용의 단위이다.
<br/><br/>

## 트랜잭션의 성질

트랜잭션은 ACID라 하는 4가지 성질들을 통해 안전한 수행을 보장한다.

### 원자성(Atomicity)

- 트랜잭션 내에서 실행한 작업들은 마치 하나의 작업인 것처럼 모두 성공 하든가 모두 실패해야 한다.

### 일관성(Consistency)

- 모든 트랜잭션은 일관성 있는 데이터베이스 상태를 유지해야 한다. (데이터베이스 무결성 제약조건)

### 격리성(Isolation)

- 동시에 실행되는 트랜잭션들이 서로에게 영향을 미치지 않도록 격리한다.
- 동시에 같은 데이터를 수정하지 못하도록 해야 하며 동시성과 관련된 성능 이슈로 인해 격리 수준을 선택할 수 있다.

### 지속성(Durability)

- 트랜잭션을 성공적으로 마치면 그 결과가 항상 저장되어야 한다.
- 중간에 시스템에 문제가 발생해도 데이터베이스 로그 등을 사용해서 성공한 트랜잭션 내용을 복구해야 한다.
<br/><br/>

## 트랜잭션의 격리성

트랜잭션은 원자성, 일관성, 지속성을 보장하지만 격리성에 대해서는 격리 수준과 그에 따른 문제점들을 꼭 알고 있어야한다.
<br/><br/>

## 격리성으로 인해 나타날 수 있는 문제점

### Dirty Read

- 다른 트랜잭션에 의해 수정 되었지만 아직 커밋되지 않은 데이터를 읽는 것을 말한다.
- 트랜잭션 1이 회원 A를 수정하고 있는데 트랜잭션 2가 수정중인 데이터를 조회할 수 있다.

### Non-Repeatable Read

- 한 트랜잭션 내에서 같은 Key를 가진 Row를 두 번 읽었는데 그 사이에 값이 변경되거나 삭제되어 결과가 다르게 나타나는 현상을 말한다.
- 트랜잭션 1이 회원 A를 조회 중인데 트랜잭션 2가 회원 A를 수정하고 커밋하게 되면 트랜잭션 1이 다시 회원 A를 조회 했을 때 수정된 데이터가 조회된다.

### Phantom Read

- 한 트랜잭션 내에서 반복 조회 시 결과 집합이 달라지는 것을 말한다.
- 트랜잭션 1이 10살 이하의 회원을 조회했는데 트랜잭션 2가 5살 회원을 추가하고 커밋하면 
트랜잭션 1이 다시 10살 이하의 회원을 조회했을 때 회원 하나가 추가된 상태로 조회된다.
<br/><br/>

## 격리수준과 문제점

트랜잭션이 격리성을 완벽히 보장하려면 트랜잭션을 거의 차례대로 실행해야 하는데,
이렇게 처리하게 되면 동시성 처리 성능이 매우 나빠지므로 ANSI 표준은 트랜잭션의 격리수준을 4단계로 나누어 정의했다.

### READ UNCOMMITED(커밋되지 않은 읽기)

- 커밋하지 않은 데이터를 읽을 수 있다.
- Drity Read가 발생할 수 있다

### READ COMMITTED(커밋된 읽기)

- 커밋한 데이터만 읽을 수 있다
- Drity Read는 발생하지 않으나 Non-Repeatable Read는 발생할 수 있다.

### REPEATABLE READ(반복 가능한 읽기)

- 한 번 조회한 데이터를 반복해서 조회해도 같은 데이터가 조회된다.
- Phantom Read는 발생할 수 있다.

### SERIALIZABLE(직렬화가능)

- 가장 엄격한 트랜잭션 격리 수준이다.
- Phantom Read는 발생하지 않으나 동시성 처리 성능이 급격히 떨어질 수 있다.
<br/><br/>

격리 수준이 낮은 순서대로 정렬 하였으며 READ UNCOMMITED의 가장 낮고 SERIALIZABLE의 격리 수준이 가장 높다. 
격리 수준이 낮을 수록 동시성은 증가하지만 그에 따른 문제점들이 존재한다.

애플리케이션 대부분은 동시성 처리가 중요하므로 데이터베이스들은 보통 READ COMMITTED 격리 수준을 기본으로 사용한다. 
일부 중요한 비즈니스 로직 에 더 높은 격리 수준이 필요하면 데이터베이스 트랜잭션이 제공하는 잠금 기능을 사용하면 된다.

| 격리 수준 | Dirty Read | Non Repeatable Read | Phantom Read |
| ------- | ---------- |-------------------- | ------------ |
|READ UNCOMMITED| O | O | O |
|READ COMMITTED|  | O | O |
|REPEATABLE READ|  |  | O |
|SERIALIZABLE|  |  |  |
<br/>

### 참고
- 자바 표준 ORM JPA 프로그래밍 (김영한 님)
- [https://sabarada.tistory.com/117](https://sabarada.tistory.com/117)
