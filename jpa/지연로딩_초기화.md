# ë‹¤ì–‘í•œ ì—°ê´€ê´€ê³„ì—ì„œ ë‹¤(Many)ì˜ ìš”ì†Œë¥¼ ì¶”ê°€í•  ë•Œ ì§€ì—°ë¡œë”©ì´ ì´ˆê¸°í™” ë ê¹Œ?

## 1. ì˜ˆì œì½”ë“œ

í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ì˜ˆì œ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
ê° ì—°ê´€ê´€ê³„ ë³„ í™•ì¸ì„ ìœ„í•´ `Team` ê³¼ `Member`ëŠ” ManyToOne ì–‘ë°©í–¥ ê´€ê³„ë¥¼,  `Team`ê³¼ `Sponser`ëŠ” OneToMany ë‹¨ë°©í–¥ ê´€ê³„ë¥¼ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.

**Team**

```java
@Getter
@NoArgsConstructor(access = PROTECTED)
@Entity
public class Team {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "team_id")
    private Long id;

    private String title;

    @OneToMany(mappedBy = "team", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Member> members = new ArrayList<>();

    @OneToMany(cascade = CascadeType.ALL, orphanRemoval = true)
    @JoinColumn(name = "team_id")
    private List<Sponsor> sponsors = new ArrayList<>();

    public Team(final String title) {
        this.title = title;
    }

    public void add(final Member member) {
		member.join(this);
        this.members.add(member);
    }

    public void add(final Sponsor sponsor) {
        this.sponsors.add(sponsor);
    }
}
```

**Member**

```java
@EqualsAndHashCode(of = "id")
@Getter
@NoArgsConstructor(access = PROTECTED)
@Entity
public class Member {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String username;

    @ManyToOne
    @JoinColumn(name = "team_id")
    private Team team;

    public Member(String username) {
        this.username = username;
    }

    public void join(Team team) {
        this.team = team;
    }
}
```

**Sponsor**

```java
@EqualsAndHashCode(of = "id")
@Getter
@NoArgsConstructor(access = PROTECTED)
@Entity
public class Sponsor {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    public Sponsor(final String name) {
        this.name = name;
    }
}
```

## 2. ë¬¸ì œí™•ì¸

### 2-1. ManyToOne ì–‘ë°©í–¥ ê´€ê³„

ManyToOne ì—°ê´€ê´€ê³„ì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

![](./image/ë‹¤ëŒ€ì¼_ì–‘ë°©í–¥_ì—°ê´€ê´€ê³„_ì§€ì—°ë¡œë”©_ì´ˆê¸°í™”.png)

í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ë³´ê²Œ ë˜ë©´?

![](./image/ë‹¤ëŒ€ì¼_ì–‘ë°©í–¥_ì—°ê´€ê´€ê³„_ì§€ì—°ë¡œë”©_ì´ˆê¸°í™”_ê²°ê³¼.png)

Memberì— ëŒ€í•œ select ì¿¼ë¦¬ëŠ” ë°œìƒí•˜ì§€ ì•Šê³  insert ì¿¼ë¦¬ë§Œ ë°œìƒí–ˆìŠµë‹ˆë‹¤. 
ì¦‰, **ì§€ì—°ë¡œë”©ì— ëŒ€í•œ ì´ˆê¸°í™” ì—†ì´ ë³€ê²½ê°ì§€ê°€ ë™ì‘**í•´ì„œ ìƒˆë¡œìš´ Memberê°€ ì¶”ê°€ëœ ê²ƒì…ë‹ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ OneToMany ë‹¨ë°©í–¥ ê´€ê³„ë„ í…ŒìŠ¤íŠ¸í•´ë³´ê² ìŠµë‹ˆë‹¤.

### 2-2. OneToMany ë‹¨ë°©í–¥ ê´€ê³„

OneToMany ë‹¨ë°©í–¥ ì—°ê´€ê´€ê³„ì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

![](./image/ì¼ëŒ€ë‹¤_ë‹¨ë°©í–¥_ì—°ê´€ê´€ê³„_ì§€ì—°ë¡œë”©_ì´ˆê¸°í™”.png)

í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ë³´ê²Œ ë˜ë©´?

![](./image/ì¼ëŒ€ë‹¤_ë‹¨ë°©í–¥_ì—°ê´€ê´€ê³„_ì§€ì—°ë¡œë”©_ì´ˆê¸°í™”_ê²°ê³¼.png)

select ì¿¼ë¦¬ê°€ ë°œìƒí•˜ì˜€ëŠ”ë°, ê·¸ ì‹œì ì´ ì¡°ê¸ˆ ì´ìƒí•´ë³´ì…ë‹ˆë‹¤. ë°œìƒí•˜ë”ë¼ë„ `em.flush()` ì¼ ê²ƒì´ë¼ ì˜ˆìƒ í•˜ì˜€ëŠ”ë°ìš”, ì˜ˆìƒì¹˜ ëª»í•œ `persistedTeam.add(new Sponsor("ìš°ì•„í•œí˜•ì œë“¤"))` ì—ì„œ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤. 

### 2.3 ë¬¸ì œ ì›ì¸

ì´ ë¬¸ì œì— ëŒ€í•œ ì›ì¸ì€ í•˜ì´ë²„ë„¤ì´íŠ¸ê°€ ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë§Œë“¤ ë•Œ ì»¬ë ‰ì…˜ í•„ë“œë¥¼ í•˜ì´ë²„ë„¤ì´íŠ¸ì—ì„œ ì¤€ë¹„í•œ ì»¬ë ‰ì…˜ìœ¼ë¡œ ë˜í•‘í•˜ëŠ” í´ë˜ìŠ¤ì— ìˆì—ˆìŠµë‹ˆë‹¤.

ì•„ë˜ëŠ” ìœ„ ì˜ˆì œì˜ Listë¥¼ ê°ì‹¸ê³ ìˆëŠ” í•˜ì´ë²„ë„¤ì´íŠ¸ì˜ êµ¬í˜„ì²´ì¸ PersistentBagì˜ ì½”ë“œì…ë‹ˆë‹¤.

![](./image/PersistentBag_add.png)

í(ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì™€ ì—°ê´€ì´ ìˆëŠ” ë“¯ í•©ë‹ˆë‹¤)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ ì—¬ë¶€ì— ë”°ë¼ì„œ ë‘ê°œì˜ ë¶„ê¸°ê°€ ë‚˜ëˆ„ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.

1. if ë¡œì§: ì»¬ë ‰ì…˜ì„ ì´ˆê¸°í™”í•œë‹¤.

2. else ë¡œì§: íì— ì¶”ê°€í•œë‹¤. 

booleanì„ ë°˜í™˜í•˜ëŠ” `isOperationQueueEnabled()` êµ¬í˜„ì— ë“¤ì–´ê°€ ë³´ë©´ ì•„ë˜ ì—°ê´€ê´€ê³„ì— ëŒ€í•œ And ì¡°ê±´ì´ ìˆìŠµë‹ˆë‹¤.

![](./image/ì—°ê´€ê´€ê³„_ì¡°ê±´.png)

í•´ë‹¹ ë¡œì§ì„ í†µí•´ ì¶”ê°€í•˜ëŠ” ì»¬ë ‰ì…˜ì´ ì—°ê´€ê´€ê³„ì˜ ì—­ì´ë¼ë©´ ì»¬ë ‰ì…˜ì„ ì´ˆê¸°í™”í•˜ëŠ” ê²ƒì„ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

> ì—°ê´€ê´€ê³„ì˜ ì—­ì´ë€ ì™¸ë˜í‚¤ë¥¼ ì£¼ í…Œì´ë¸”ì˜ ì—”í‹°í‹°ê°€ ì•„ë‹Œ ëŒ€ìƒ í…Œì´ë¸”ì˜ ì—”í‹°í‹°ì—ì„œ ê´€ë¦¬í•˜ëŠ” ê²ƒì„ ì´ì•¼ê¸°í•©ë‹ˆë‹¤.  
ì´ ë¶€ë¶„ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ JPAì˜ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ì„ ì°¾ì•„ë³´ì‹œê¸°ë¥¼ ì¶”ì²œë“œë¦½ë‹ˆë‹¤. :)

## 3. ë§ˆë¬´ë¦¬

ë¬¸ì œì— ëŒ€í•œ ë‹µì„ ì •ë¦¬í•´ë³´ê² ìŠµë‹ˆë‹¤.

1. ManyToOne ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ëŠ” ì—°ê´€ê´€ê³„ì˜ ì—­ì´ ì•„ë‹ˆë¯€ë¡œ ì»¬ë ‰ì…˜ì„ ì´ˆê¸°í™”í•˜ì§€ ì•ŠëŠ”ë‹¤.
2. OneToMany ë‹¨ë°©í–¥ ì—°ê´€ê´€ê³„ëŠ” ì—°ê´€ê´€ê³„ì˜ ì—­ì´ë¯€ë¡œ ì»¬ë ‰ì…˜ì„ ì´ˆê¸°í™”í•œë‹¤.

ê·¸ë¦¬ê³  1ë²ˆê³¼ ê°™ì´ ì—”í‹°í‹°ë¥¼ ì¶”ê°€í•  ë•Œ ì»¬ë ‰ì…˜ì„ ì´ˆê¸°í™”í•˜ì§€ ì•ŠëŠ” ì´ìœ ëŠ” êµ­ë‚´ JPAì˜ ì•„ë²„ì§€ë¼ ë¶ˆë¦¬ëŠ” ê¹€ì˜í•œë‹˜ì˜ ì±…ì—ì„œ ì°¾ì„ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

> Collection, ListëŠ” ì—”í‹°í‹°ë¥¼ ì¶”ê°€í•  ë•Œ ì¤‘ë³µëœ ì—”í‹°í‹°ê°€ ìˆëŠ”ì§€ ë¹„êµí•˜ì§€ ì•Šê³  ë‹¨ìˆœíˆ ì €ì¥ë§Œ í•˜ë©´ ëœë‹¤. ë”°ë¼ì„œ ì—”í‹°í‹°ë¥¼ ì¶”ê°€í•´ë„ ì§€ì—° ë¡œë”©ëœ ì»¬ë ‰ì…˜ì„ ì´ˆê¸°í™”
í•˜ì§€ ì•ŠëŠ”ë‹¤.

ì´ë ‡ê²Œ ì •ë¦¬í•´ë³´ë‹ˆ ê¹€ì˜í•œë‹˜ì˜ ì¡°ì–¸ê³¼ ê°™ì´ OneToMany ë‹¨ë°©í–¥ ë³´ë‹¤ëŠ” ManyToOne ì–‘ë°©í–¥ì„ ì¨ì•¼í•˜ëŠ” í° ì´ìœ ê°€ í•œê°€ì§€ ë” ìƒê¸´ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ğŸ™‚

## ì°¸ê³ 
- ìë°” ORM í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë°
