# 페치조인이란 ? (부제: 페치조인 vs 일반조인) 

## 페치조인이란 ?
- 페치조인은 SQL에서 이야기하는 조인의 종류는 아니며 JPQL에서 성능 최적화를 위해 제공하는 기능이다.
- 엔티티를 조회할 때 연관된 엔티티나 컬렉션을 한 번에 같이 조회하는기능인데 join fetch 명령어로 사용할 수 있다.  
- 기본적인 조인 전략은 Left Inner 조인이며 `left outer join fetch` 명령으로 Left Outer 조인으로 설정도 가능하다. 
[(내부조인과 외부조인을 어느 상황에 사용하여야 할까?)](https://github.com/leeyohan93/TIL/blob/master/spring/jpa/JpaJoinStrategy.md)
`select m from Memberm join fetch m.team`

## 패치조인을 왜 사용해야 하는가 ?
- 페치 조인을 사용하면 SQL 한 번으로 연관된 엔티티들을 함께 조회할 수 있어서 SQL 호출 횟수를 줄여 성능을 최적화할 수 있다.
- 페치 조인을 사용하게 되면 객체 그래프(엔티티 간의 연관관계)를 유지하며 조회가 가능하다.
    - Member 엔티티와 Team 엔티티를 페치조인하여 조회하였다면 Team 엔티티도 프록시가 아닌 실제 엔티티이다.
    - 일반 조인을 사용하게되면 연관관계를 고려하지 않는다. 즉 Team 엔티티를 조회해오지 못한다. (SELECT 절에 지정한 엔티티만 조회한다.)
- n+1 문제
    - n+1 문제가 어떤 문제인지는 따로 다루기로 하고 페치조인을 하지 않으면 n+1 문제가 생기는건 아니지만 페치조인을 함으로 써 n+1 문제를 해결할 수 있다.

## 페치 조인 시 주의 사항
- 최적화를 위해 글로벌 로딩 전략을 즉시 로딩으로 설정하면 애플리케이션 전체에 서 항상 즉시 로딩이 일어난다.  
  물론 일부는 빠를 수는 있지만 전체로 보면 사용하지 않는 엔티티를 자주 로딩하므로 오히려 성능에 악영향을 미칠 수 있다.  
  따라서 글로벌 로딩 전략은 될 수 있으면 지연 로딩을 사용하고 최적화가 필요하면 페치 조인을 적용하는 것이 효과적이다.
- 일반적인 JPQL 조인과는 다르게 페치 조인은 별칭을 사용할 수 없다. (ex. select t from Team t join fetch t.members m) -> X
    - JPA 표준에서는 지원하지 않지만 하이버네이트를 포함한 몇몇 구현체들은 페치 조인에 별칭을 지원한다.  
    하지만 별칭을 잘못 사용하면 연관된 데이터 수가 달라져서 데이터 무결성이 깨질 수 있으므로 조심해서 사용해야 한다.
- fetch join의 대상은 on, where 등에서 필터링 조건으로 사용하면 안된다.
    - `select t from Team t join fetch t.members m where m.username = 'm1'` 쿼리를 실행하게 된다면 username이 'm1'인 Member를 가진
    Team 엔티티가 조회될 것이다. 하지만 데이터베이스의 해당 Team 에 여러 Member를 가지고 있다면 객체의 상태와 DB의 상태 일관성이 깨지게 된다. 
    - `Select m from Member m join fetch  m.team t where t.name=:teamName` 이와 같은 쿼리는 데이터베이스와 일관성이 있기 때문에 사용이 가능하다. 
    단 이 쿼리를 left join fetch 로 변경하게 된다면 일관성이 깨지게 되므로 주의해야 한다.
- 컬렉션을 페치 조인하면 페이징 API를 사용할 수 없다.
    - [하지만 페이징이 필요하다면 ?](https://github.com/leeyohan93/TIL/blob/master/spring/jpa/컬렉션_페치조인_페이징.md)
- 둘 이상의 컬렉션을 페치할 수 없다. (카테시안 곱 주의)
- 여러 테이블을 조인해서 엔티티가 가진 모양이 아닌 전혀 다른 결과를 내야 하다면 억지로 페치 조인을 사용하기보다는 여러 테이블에서 필요한 필드들만 조회해서 DTO로 반환하는 것이 더 효과적 일 수 있다.
    
## 페치조인과 일반조인의 차이점은 무엇일까 ? 
- 연관된 엔티티를 같이 조회할 수 있느냐 없느냐.

## 참고
-  자바 ORM 표준 JPA 프로그래밍 / 김영한 
- [인프런 질의응답](https://www.inflearn.com/questions/15876)
